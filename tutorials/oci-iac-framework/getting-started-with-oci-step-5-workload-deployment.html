<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.23.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Workload Deployment - Oracle Dev.O Tutorials</title>
<meta name="description" content="How to deploy and configure your code on the OCLOUD framework landing zone">


  <meta name="author" content="Malte Menkhoff">
  
  <meta property="article:author" content="Malte Menkhoff">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Oracle Dev.O Tutorials">
<meta property="og:title" content="Workload Deployment">
<meta property="og:url" content="https://cool.devo.build/tutorials/oci-iac-framework/getting-started-with-oci-step-5-workload-deployment">


  <meta property="og:description" content="How to deploy and configure your code on the OCLOUD framework landing zone">



  <meta property="og:image" content="https://cool.devo.build/tutorials/oci-iac-framework/assets/landing-zone.png">




  <meta name="twitter:site" content="@groundbreakers">
  <meta name="twitter:title" content="Workload Deployment">
  <meta name="twitter:description" content="How to deploy and configure your code on the OCLOUD framework landing zone">
  <meta name="twitter:url" content="https://cool.devo.build/tutorials/oci-iac-framework/getting-started-with-oci-step-5-workload-deployment">

  
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://cool.devo.build/tutorials/oci-iac-framework/assets/landing-zone.png">
    
  

  



  <meta property="article:published_time" content="2021-10-18T20:00:00+00:00">






<link rel="canonical" href="https://cool.devo.build/tutorials/oci-iac-framework/getting-started-with-oci-step-5-workload-deployment">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://cool.devo.build/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/main.xml" type="application/atom+xml" rel="alternate" title="Oracle Dev.O Tutorials Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



<link rel="icon" href="https://www.oracle.com/asset/web/favicons/favicon-32.png" sizes="32x32">

    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead oracle-header oracle-headerv1 oracle-headeradj oracle-headerdev">
  <div class="masthead__inner-wrap oracle-headerw1">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <div class="oracle-headers1 site-logo">
          <a class="oracle-logo" href="https://developer.oracle.com/"><span>Oracle</span></a>
        </div>
        <div class="u18-title site-title">
          <a href="/">
            Oracle Dev.O Tutorials
            
          </a>
        </div>

        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/use-cases/">Use Cases</a>
            </li><li class="masthead__menu-item">
              <a href="/topics/">Topics</a>
            </li><li class="masthead__menu-item">
            <a href="https://www.oracle.com/cloud/free/?source=:ow:o:s:nav::DevoGetStarted&intcmp=:ow:o:s:nav::DevoGetStarted">Get Started For Free</a>
          </li>
        </ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a href="https://developer.oracle.com/" itemprop="item"><span itemprop="name">Developer Resource Center</span></a>
      <meta itemprop="position" content="" />
    </li>
    <span class="sep">/</span>
    
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" itemprop="item"><span itemprop="name">Dev.O Tutorials</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/tutorials" itemprop="item"><span itemprop="name">Tutorials</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/tutorials/oci-iac-framework" itemprop="item"><span itemprop="name">Oci iac framework</span></a>
          <meta itemprop="position" content="3" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Workload Deployment</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">

    <div class="sidebar sticky">
    <p><strong>Tags:</strong> <span class="tags">

            
            <a class="animated-link tag" href="/topics/open-source">open-source</a>
            <a class="animated-link tag" href="/topics/terraform">terraform</a>
            <a class="animated-link tag" href="/topics/iac">iac</a>
            <a class="animated-link tag" href="/topics/devops">devops</a>
            <a class="animated-link tag" href="/topics/beginner">beginner</a>
            </span>
    </p>
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Malte Menkhoff</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malte is a passioned solution architect and is supporting customers in the DACH region in migrating to OCI.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      
        <li>
          <a href="mailto:malte.menkhoff@oracle.com">
            <meta itemprop="email" content="malte.menkhoff@oracle.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/kubemen" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  
  
  <p><strong>From this author:</strong>
    <ul>
      
        <li><a href="/tutorials/oci-iac-framework/getting-started-with-oci-intro">Getting Started with Oracle Cloud Infrastructure (OCI)</a></li>
      
        <li><a href="/tutorials/oci-iac-framework/getting-started-with-oci-step-1-provider">Automating OCI with Terraform</a></li>
      
        <li><a href="/tutorials/oci-iac-framework/getting-started-with-oci-step-2-base">Service Delivery Framework</a></li>
      
        <li><a href="/tutorials/oci-iac-framework/getting-started-with-oci-step-3-database-infrastructure">Database Infrastructure</a></li>
      
        <li><a href="/tutorials/oci-iac-framework/getting-started-with-oci-step-4-app-infrastructure">Application Infrastructure</a></li>
      
        <li><a href="/tutorials/oci-iac-framework/getting-started-with-oci-step-6-governance">Governance</a></li>
      
        <li><a href="/tutorials/oci-iac-framework/">Oracle Cloud Infrastructure IaC Framework</a></li>
      
    </ul>
  
  

  </div>


  <article class="page has-sidebar has-toc" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Workload Deployment">
    
    <meta itemprop="datePublished" content="2021-10-18T20:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Workload Deployment
</h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#operator-host">Operator Host</a><ul><li><a href="#access-to-operator-host">Access to Operator Host</a></li></ul></li><li><a href="#oci-tool-support-for-automation--configuration-management">OCI Tool Support for automation &amp; configuration management</a><ul><li><a href="#ansible">Ansible</a></li><li><a href="#puppet">Puppet</a></li><li><a href="#chef">Chef</a></li><li><a href="#helm">Helm</a></li></ul></li><li><a href="#demonstration-of-a-helm-deployment">Demonstration of a Helm deployment</a></li></ul>

            </nav>
          </aside>
        

        <picture class="aligncenter">
                <source srcset="assets/landing-zone.png 1x" />
                <img loading="lazy" width="400" height="400" src="assets/landing-zone.png" data-original="assets/landing-zone.png" data-at2x="assets/landing-zone@2x.png" alt="OCLOUD landing zone" title="OCLOUD landing zone" />
            </picture>

<p>Best practice from Oracle for workload on OCI is to use the concept of an operator host to install and maintain the service application and configuration for the workload.</p>

<p>As the number of applications and needed configurations varies, the goal of this step is to dig a bit deeper in the concept of the operator host and which configuration and automation tools can be used on OCI to deploy your workload.</p>

<h2 id="operator-host">Operator Host</h2>
<p>The aim of the operator host is:</p>
<ol>
  <li>Performing post-provisioning tasks with any automation tools which requires a local installation.</li>
  <li>Provide administrators access without the need to upload api authentication keys (instance_principal).</li>
</ol>

<h3 id="access-to-operator-host">Access to Operator Host</h3>
<p>As described in the base section, OCI provides the ability to use a bastion service for a controlled and secure access to ressources in your tenancy.</p>

<p>The operator host concept leverages this service, providing administrators and application hosts a quick and secure mechanism to access a system which can run scripts or any automation tool for maintaining and operating the services.</p>

<h2 id="oci-tool-support-for-automation--configuration-management">OCI Tool Support for automation &amp; configuration management</h2>
<p>The use of Terraform is mostly in defining the infrastructure to host the applications for the service. Terraform itself is not naturally designed to do certain application installation or configuration tasks.</p>

<p>Oracle is not recommending to use any of the described tools as the right way to go for customers or prospects - instead Oracle is describing how to use the most commons tools on the market in combination with Terraform to provide and guide customers with best practices. It is up to the customer and their requirements to define which is the tool combination for their individual workload and which best fulfills their needs.</p>

<p>There are a number of external tools which can be used to automate the workload deployment. Terraform is focussed on IaC and has it strength in provisioning infrastructure resources there is potentially a need to use further tools to install, configure and manage applications on top of the infrastracture.</p>

<p>We will focus in this session on how to use the most common tools like Ansible, Puppet, and Chef, and we will show how they can be used.</p>

<p>The focus of this session is on cloud-native, thus we will show you in a demo how you can leverage helm charts to deploy workload via the Oracle Resource Manager onto an OKE cluster which has been deployed in the previous session.</p>

<h3 id="ansible"><strong>Ansible</strong></h3>
<p>OCI supports the use of Ansibles modules to automate cloud infrastructure provisioning and configuration, orchestrating of complex operation process, and deployment and update of your software assets.</p>
<picture class="">
                <source srcset="assets/ansible.png 1x" />
                <img loading="lazy" src="assets/ansible.png" data-original="assets/ansible.png" data-at2x="assets/ansible@2x.png" alt="Ansible" title="Ansible" />
            </picture>

<p>The OCI Ansible collection supports Ansible Tower and AWX. For more information on how to set up the collection with Ansible Tower, refer to the <a href="https://blogs.oracle.com/cloud-infrastructure/post/using-oracle-cloud-infrastructure-with-ansible-tower-and-awx">ansible_blogpost</a>. To install the free version of Ansible Tower (AWX) on an OCI Compute instance, you can use <a href="https://github.com/oracle-quickstart/oci-ansible-awx">ansible solution on GitHub</a> and the following <a href="https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/ansiblesamples.htm#Sample_Ansible_Playbooks">ansible example playbooks</a></p>

<p>A complete example how you can use Ansible to deploy Kubernetes, Istio and an example service can be found here: https://blog.kube-mesh.io/single-click-deployment-of-oke-istio-mushop-using-ansible-from-oci-cloud-shell/<br />
Link: <a href="https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/ansible.htm">ansible_collection</a></p>

<h3 id="puppet"><strong>Puppet</strong></h3>
<p>While many organizations are using Terraform to provision Oracle cloud resources, a solution for continuous integration should be considered when it comes to ongoing management of resources. That’s where Puppet can help. With Puppet you can:</p>
<ul>
  <li>Integrate cloud resources into your existing infrastructure, and manage everything with one tool.</li>
  <li>Use existing <a href="https://puppet.com/docs/puppet/5.5/hiera_intro.html">puppet_hiera</a> data to configure parts of your OCI infrastructure.</li>
  <li>Have a tighter integration between OCI configuration in general and the configuration management on your systems.</li>
</ul>

<p>The oci_config module extends the Puppet language to contain types needed to create and manage the lifecycle of objects within your Oracle Cloud Infrastructure. Although this is traditionally the domain of Terraform scripts, being able to manage these objects with Puppet has proven to be a big plus for many customers. For example:</p>
<ul>
  <li>Your organization is already using Puppet and not Terraform. Introducing a new tool into your organization might be more then you want or need. In these cases, Puppet, in combination with this module, is a great help.</li>
  <li>You want to use existing hiera data to configure parts of your OCI infrastructure. In this case, using this module is great. It integrates with all of the existing hieradata, just like your other Puppet code.</li>
  <li>You need tighter integration between OCI configuration in general and the configuration management on your systems. Again, this module is for you. It is regular Puppet so you can use all of the rich Puppet features like exported resources to integrate all of your configuration settings both on the cloud level as well as on the machines.</li>
</ul>

<p><strong>Puppet example code:</strong><br />
Configuration of using a tenant:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ puppet apply /software/tenant_setup.pp
Notice: Compiled catalog for oci in environment production in 0.09 seconds
Notice: /Stage[main]/Main/Oci_tenant[enterprisemodules]/fingerprint: defined 'fingerprint' as 'xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx'
Notice: /Stage[main]/Main/Oci_tenant[enterprisemodules]/private_key: created with specified value
Notice: /Stage[main]/Main/Oci_tenant[enterprisemodules]/region: defined 'region' as 'eu-frankfurt-1'
Notice: /Stage[main]/Main/Oci_tenant[enterprisemodules]/tenancy_ocid: defined 'tenancy_ocid' as 'ocid1.tenancy.oc1..xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
Notice: /Stage[main]/Main/Oci_tenant[enterprisemodules]/user_ocid: defined 'user_ocid' as 'ocid1.user.oc1..xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
Notice: Applied catalog in 0.02 seconds
</code></pre></div></div>
<p>First inspection:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ puppet resource oci_identity_compartment
bash-4.2# puppet resource oci_identity_compartment
*** ENTERPRISE MODULES Universal License INTERNAL USE ONLY ***
oci_identity_compartment { 'your_tenant (root)/ManagedCompartmentForPaaS':
  ensure          =&gt; 'present',
  compartment     =&gt; '/',
  compartment_id  =&gt; 'ocid1.tenancy.oc1..xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
  description     =&gt; 'idcs-f7246e2bbacf4a11a7e231507e34fdec|22626923|user@domain.com-Enterprise Modules B.V.-838062',
  id              =&gt; 'ocid1.compartment.oc1..aaaaaaaai2wkrvdvyxfuekjbt3jnv7b4hrlkvwnklu6uryy2daqsq425tzaa',
  lifecycle_state =&gt; 'ACTIVE',
  provider        =&gt; 'sdk',
  time_created    =&gt; '2019-10-24T08:42:26+00:00',
}
oci_identity_compartment { 'your_tenant (root)/test_compartment_1':
  ensure          =&gt; 'present',
  compartment     =&gt; '/',
  compartment_id  =&gt; 'ocid1.tenancy.oc1..xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
  description     =&gt; 'changed',
  id              =&gt; 'ocid1.compartment.oc1..aaaaaaaatfskqfckrl4sucabclbsss47uyttlmwwur6lsm7crl3lrz7glfta',
  lifecycle_state =&gt; 'ACTIVE',
  provider        =&gt; 'sdk',
  time_created    =&gt; '2020-01-23T15:42:35+00:00',
}
</code></pre></div></div>
<p><em>(available via [this link] (https://www.enterprisemodules.com/blog/2020/02/getting-to-know-oracle-cloud-with-puppet-part-1/))</em></p>

<p><strong>Learn more</strong></p>
<ul>
  <li>Download the oci_config module from <a href="https://forge.puppet.com/enterprisemodules/oci_config?_ga=2.53914861.492612131.1628576569-1666656837.1628576569">puppet_forge</a></li>
  <li>Read the <a href="https://www.enterprisemodules.com/blog/2020/02/getting-to-know-oracle-cloud-with-puppet-part-1/">puppet_enterprise_guide</a> to installing the oci_config Puppet module</li>
  <li>Follow the guide to <a href="https://forge.puppet.com/configuration-management/enterprisemodules/deploy-oracle-19c?_ga=2.93880664.492612131.1628576569-1666656837.1628576569">deploy_an_Oracle19_database_via_puppet</a><br />
Link by Puppet: <a href="https://puppet.com/blog/configure-and-manage-oracle-cloud-infrastructure-components-with-puppet/">puppet_blog</a></li>
</ul>

<h3 id="chef"><strong>Chef</strong></h3>
<p>Chef is a powerful automation platform that transforms infrastructure into code. Whether you’re operating in the cloud, on-premises, or in a hybrid environment, Chef automates how infrastructure is configured, deployed, and managed across your network, no matter its size.</p>

<p>This diagram shows how you develop, test, and deploy your Chef code</p>
<picture class="">
                <source srcset="assets/chef.png 1x" />
                <img loading="lazy" src="assets/chef.png" data-original="assets/chef.png" data-at2x="assets/chef@2x.png" alt="Chef" title="Chef" />
            </picture>
<p><em>(Image Courtesy https://docs.chef.io/platform_overview.html)</em>
<em>Chef Plugin for OCI</em></p>

<p>The <strong>knife-oci</strong> plugin allows users to interact with Oracle Cloud Infrastructure through chef knife.</p>

<p>The home page for the project is <a href="https://docs.us-phoenix-1.oraclecloud.com/Content/API/SDKDocs/knifeplugin.htm">here</a>. Plugin can be downloaded from <a href="https://github.com/oracle/knife-oci/releases">this</a> location.</p>

<p>Following are the knife-oci plugin commands available.</p>
<ul>
  <li>Launch an OCI instance and bootstrap it as a Chef node: <em>knife oci server create</em></li>
  <li>List OCI compartments: <em>knife oci compartment list</em></li>
  <li>Delete an OCI instance: <em>knife oci server delete</em></li>
  <li>List OCI instances in a given compartment. Note: All instances in the compartment are returned, not only those that are Chef nodes: <em>knife oci server list</em></li>
  <li>List the images in a compartment: <em>knife oci image list</em></li>
  <li>List the VCNs in a compartment: <em>knife oci vcn list</em></li>
  <li>List the subnets in a VCN: <em>knife oci subnet list</em></li>
  <li>List the shapes that may be used for a particular image type: <em>knife oci shape list</em></li>
  <li>List the availability domains for your tenancy: <em>knife oci ad list</em></li>
</ul>

<p>How to setup the knife-oci plugin can be found here: https://medium.com/oracledevs/using-oracles-chef-plugin-to-provision-resource-in-oracle-cloud-infrastructure-5891100e20ab<br />
OCI documentation for chef is available here: <a href="https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/knifeplugin.htm">chef_plugin</a></p>

<h3 id="helm"><strong>Helm</strong></h3>
<p>Helm helps you manage Kubernetes applications — Helm Charts help you define, install, and upgrade even the most complex Kubernetes application.<br />
Charts are easy to create, version, share, and publish — so start using Helm and stop the copy-and-paste.</p>

<p>The advantages of using Helm for the deployment of applications on top of Kubernetes are:</p>
<ul>
  <li>Manage Complexity</li>
  <li>Easy Updates</li>
  <li>Simple Sharing</li>
  <li>Rollbacks</li>
</ul>

<p>The Oracle Resource Manager (ORM) supports the Terraform provider for Helm and can be easily used in combination with the Terraform Kubernetes providers.<br />
Details about Third-party Provider Versions for ORM can be found here: https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/providers.htm</p>

<p>In order to get the needed information about the Kubernetes cluster it is needed to get the content of the Kubernetes cluster which has been deployed.
This can be achieved for the Kubernetes and Helm provider in the following way:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Gets kubeconfig
data "oci_containerengine_cluster_kube_config" "oke_cluster_kube_config" {
  cluster_id = oci_containerengine_cluster.oke_cluster.id
}

# https://docs.cloud.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengdownloadkubeconfigfile.htm#notes
provider "kubernetes" {
  load_config_file       = "false" # Workaround for tf k8s provider &lt; 1.11.1 to work with ORM
  cluster_ca_certificate = base64decode(yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["clusters"][0]["cluster"]["certificate-authority-data"])
  host                   = yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["clusters"][0]["cluster"]["server"]
  exec {
    api_version = "client.authentication.k8s.io/v1beta1" # Workaround for tf k8s provider &lt; 1.11.1 to work with orm - yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["apiVersion"]
    args = [yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][0],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][1],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][2],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][3],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][4],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][5],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][6]]
      command = yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["command"]
  }
}

# https://docs.cloud.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengdownloadkubeconfigfile.htm#notes
provider "helm" {
  kubernetes {
    load_config_file       = "false" # Workaround for tf helm provider &lt; 1.1.1 to work with ORM
    cluster_ca_certificate = base64decode(yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["clusters"][0]["cluster"]["certificate-authority-data"])
    host                   = yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["clusters"][0]["cluster"]["server"]
    exec {
      api_version = yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["apiVersion"]
      args = [yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][0],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][1],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][2],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][3],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][4],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][5],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][6]]
        command = yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["command"]
    }
  }
}

</code></pre></div></div>

<p>It is recommended as best practice to seperate Kubernetes by service into logical entities called <em>namespaces</em>.<br />
Information about namespaces can be found [here.] (https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/)</p>

<p>The following code snippet in terraform creates a namespace:</p>
<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">resource</span> <span class="s2">"kubernetes_namespace"</span> <span class="s2">"&lt;service&gt;_namespace"</span> <span class="p">{</span>
  <span class="nx">metadata</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"&lt;service&gt;"</span>
  <span class="p">}</span>
  <span class="nx">depends_on</span> <span class="p">=</span> <span class="p">[</span><span class="nx">oci_containerengine_node_pool</span><span class="p">.</span><span class="nx">oke_node_pool</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As we need to have a working Kubernetes up and ready with available worker nodes it is recommended to check and wait until the worker nodes has been deployed in a previous step of Terraform.</p>

<p>The next step would be to deploy your Kubernetes application with a helm release in the previously created namespace.</p>

<p>This can be achieved in storing your Helm files in a sub-directory of your Terraform environment, e.g. <em>helm_charts</em> and reference to your charts in your Terraform code as follows:</p>
<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">resource</span> <span class="s2">"helm_release"</span> <span class="s2">"&lt;application_1&gt;"</span> <span class="p">{</span>
  <span class="nx">depends_on</span> <span class="p">=</span> <span class="p">[</span><span class="nx">oci_containerengine_node_pool</span><span class="p">.</span><span class="nx">oke_node_pool</span><span class="p">]</span>
  <span class="nx">name</span>       <span class="p">=</span> <span class="s2">"&lt;application_1&gt;"</span>
  <span class="nx">chart</span>      <span class="p">=</span> <span class="s2">"helm_charts/&lt;application_1&gt;"</span>
  <span class="nx">namespace</span>  <span class="p">=</span> <span class="nx">kubernetes_namespace</span><span class="p">.</span><span class="err">&lt;</span><span class="nx">service</span><span class="err">&gt;</span><span class="nx">_namespace</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">wait</span>       <span class="p">=</span> <span class="kc">false</span>
  <span class="nx">timeout</span>    <span class="p">=</span> <span class="mi">300</span>
<span class="p">}</span>
</code></pre></div></div>
<p>It is as well possible to deploy multiple applications for your service in repeating the code fragment as follows:</p>
<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">resource</span> <span class="s2">"helm_release"</span> <span class="s2">"&lt;application_2&gt;"</span> <span class="p">{</span>
  <span class="nx">depends_on</span> <span class="p">=</span> <span class="p">[</span><span class="nx">oci_containerengine_node_pool</span><span class="p">.</span><span class="nx">oke_node_pool</span><span class="p">]</span>
  <span class="nx">name</span>       <span class="p">=</span> <span class="s2">"&lt;application_2&gt;"</span>
  <span class="nx">chart</span>      <span class="p">=</span> <span class="s2">"helm_charts/&lt;application_2&gt;"</span>
  <span class="nx">namespace</span>  <span class="p">=</span> <span class="nx">kubernetes_namespace</span><span class="p">.</span><span class="err">&lt;</span><span class="nx">service</span><span class="err">&gt;</span><span class="nx">_namespace</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">wait</span>       <span class="p">=</span> <span class="kc">false</span>
  <span class="nx">timeout</span>    <span class="p">=</span> <span class="mi">300</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Best practice is to set a timeout to give Helm a maximum time until the deployment has to be finished.<br />
As the Helm provider is not capable to identify if the Kubernetes deployment has been finished before we are adding a <code class="language-plaintext highlighter-rouge">depends_on</code> section to make sure that the Kubernetes cluster is up and running before deploying.</p>

<h2 id="demonstration-of-a-helm-deployment">Demonstration of a Helm deployment</h2>
<p>To demonstrate how it is possible to use the ORM to deploy workload on Kubernetes cluster we will show case an example use case in deploying a Helm release of an hivemq cluster and an kafka connector in one namespace.</p>

<p>The target setup will look as follows:</p>
<picture class="">
                <source srcset="assets/demo.png 1x" />
                <img loading="lazy" src="assets/demo.png" data-original="assets/demo.png" data-at2x="assets/demo@2x.png" alt="Demo Setup" title="Demo Setup" />
            </picture>

<p>We are using the following generic code which can be used independent of the IaaS or Kubernetes stack:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Gets kubeconfig
data "oci_containerengine_cluster_kube_config" "oke_cluster_kube_config" {
  cluster_id = oci_containerengine_cluster.oke_cluster.id
}

# https://docs.cloud.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengdownloadkubeconfigfile.htm#notes
provider "kubernetes" {
  load_config_file       = "false" # Workaround for tf k8s provider &lt; 1.11.1 to work with ORM
  cluster_ca_certificate = base64decode(yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["clusters"][0]["cluster"]["certificate-authority-data"])
  host                   = yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["clusters"][0]["cluster"]["server"]
  exec {
    api_version = "client.authentication.k8s.io/v1beta1" # Workaround for tf k8s provider &lt; 1.11.1 to work with orm - yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["apiVersion"]
    args = [yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][0],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][1],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][2],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][3],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][4],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][5],
    yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][6]]
    command = yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["command"]
  }
}

# https://docs.cloud.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengdownloadkubeconfigfile.htm#notes
provider "helm" {
  kubernetes {
    load_config_file       = "false" # Workaround for tf helm provider &lt; 1.1.1 to work with ORM
    cluster_ca_certificate = base64decode(yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["clusters"][0]["cluster"]["certificate-authority-data"])
    host                   = yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["clusters"][0]["cluster"]["server"]
    exec {
      api_version = yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["apiVersion"]
      args = [yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][0],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][1],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][2],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][3],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][4],
        yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][5],
      yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["args"][6]]
      command = yamldecode(data.oci_containerengine_cluster_kube_config.oke_cluster_kube_config.content)["users"][0]["user"]["exec"]["command"]
    }
  }
}


resource "kubernetes_namespace" "hivekafka_namespace" {
  metadata {
    name = "hivekafka"
  }
  depends_on = [oci_containerengine_node_pool.oke_node_pool]
}

resource "helm_release" "hivemq" {
  depends_on = [oci_containerengine_node_pool.oke_node_pool]
  name       = "hivemq"
  chart      = "helm_charts/hivemq"
  namespace  = kubernetes_namespace.hivekafka_namespace.id
  wait       = false
  timeout    = 300
}

# Deploy kafka-connect chart
resource "helm_release" "kafkaconnect" {
   depends_on = [oci_containerengine_node_pool.oke_node_pool]
   name      = "kafka-connect"
   chart     = "helm_charts/cp-kafka-connect"
   namespace = kubernetes_namespace.hivekafka_namespace.id
   wait      = false
   timeout   = 120
}

#Output the public IP addresses of the helm-chart generated service load balancers
resource "time_sleep" "wait_120_seconds" {
  depends_on = [helm_release.hivemq] 
  create_duration = "120s"
}

data "kubernetes_service" "oss_kafka_connect" {
  depends_on = [time_sleep.wait_120_seconds]
  metadata {
    name = "oss-kafka-connect-service"
    namespace = "hivekafka"
  }
}

data "kubernetes_service" "hivemq_mqtt" {
  depends_on = [time_sleep.wait_120_seconds]
  metadata {
    name = "hivemq-mqtt"
    namespace = "hivekafka"
  }
}

output "oss_kafka_connect_load_balancer_ip_address" {
  //value = [data.kubernetes_service.oss_kafka_connect.status.0.load_balancer.0.ingress.0.ip]
  value = [data.kubernetes_service.oss_kafka_connect.load_balancer_ingress[0].ip]
}

output "hivemq_mqtt_load_balancer_ip_address" {
  //value = [data.kubernetes_service.hivemq_mqtt.status.0.load_balancer.0.ingress.0.ip]
  value = [data.kubernetes_service.hivemq_mqtt.load_balancer_ingress[0].ip]
}
</code></pre></div></div>

<p>When you are comparing the code with the example it’s easy to see that the content itself hasn’t really changed.</p>

<p>We have only addded some output - in this case the IP addresses of the loadbalancers - which will be automaticly deployed by the Helm chart.</p>

<p>Furthermore, we have added a 120 second timeout as the loadbalancers will be deployed Kubernetes directly which Terraform is not able to see.</p>

<p>The overall output via kubectl looks likes follows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl -n hivekafka get deployments,pods,services
NAME                                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/hivemq-cluster                 3/3     3            3           61m
deployment.apps/oss-kafka-connect-deployment   2/3     3            2           61m
NAME                                                READY   STATUS             RESTARTS   AGE
pod/hivemq-cluster-59c44cdb59-fpvb9                 1/1     Running            0          61m
pod/hivemq-cluster-59c44cdb59-nw6dd                 1/1     Running            0          61m
pod/hivemq-cluster-59c44cdb59-txrt5                 1/1     Running            0          61m
pod/oss-kafka-connect-deployment-5f87774458-gbr9s   0/1     CrashLoopBackOff   11         61m
pod/oss-kafka-connect-deployment-5f87774458-qnmgr   1/1     Running            12         61m
pod/oss-kafka-connect-deployment-5f87774458-zcgpt   1/1     Running            12         61m
pod/wallet-extractor-job-9j8xl                      0/1     Completed          0          61m
NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)          AGE
service/hivemq-control-center       LoadBalancer   10.96.171.15    &lt;pending&gt;        8080:30666/TCP   61m
service/hivemq-discovery            ClusterIP      None            &lt;none&gt;           1883/TCP         61m
service/hivemq-mqtt                 LoadBalancer   10.96.49.214    129.159.77.93    1883:31094/TCP   61m
service/oss-kafka-connect-service   LoadBalancer   10.96.114.200   129.159.74.132   80:31501/TCP     61m
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td><a href="getting-started-with-oci-step-4-app-infrastructure">&lt; app-infra</a></td>
      <td><a href="index">+</a></td>
      <td><a href="getting-started-with-oci-step-6-governance">governance &gt;</a></td>
    </tr>
  </tbody>
</table>

<!--- Links -->



        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-10-18T20:00:00+00:00">October 18, 2021</time></p>


      </footer>

      

      

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/main.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Oracle</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="/assets/js/custom.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  
    <script src="/assets/js/plugins/readmore.min.js"></script>
  


<!-- Start SiteCatalyst code -->
<script>
  var s_pageName = "devrel:en-us:";
  if (typeof(document.title) != "undefined") {
    var s_pageName = s_pageName + document.title.trim()
  };
</script>
<script src="https://www.oracleimg.com/us/assets/metrics/ora_otn.js"></script>
<!-- End SiteCatalyst code -->


  </body>
</html>
